---
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import { getCollection, getEntry, type InferEntrySchema } from "astro:content";
import { Image } from "astro:assets";
import Layout from "layouts/Layout.astro";
import singapore from "@assets/putrajaya.jpg";
import SectionHeader from "@components/SectionHeader.astro";
import { getSortedEventsByCity } from "@utils/eventUtils";
import EventCard from "@components/EventCard.astro";
import Button from "@components/Button.astro";
import { getSortedNewsByCity } from "@utils/newsUtils";
import NewsCard from "@components/NewsCard.astro";
import ContentContainer from "@components/ContentContainer.astro";

export const getStaticPaths = async () => {
  {
    const { data: cities } = await getEntry("city", "cities");
    return cities.map((c) => {
      return {
        params: { city: c.name.toLowerCase() },
        props: c,
      };
    });
  }
};

type Props = InferEntrySchema<"city">[number];

const { name } = Astro.props;
const allCityEvents = getSortedEventsByCity(await getCollection("event"), name);
const allCityNews = getSortedNewsByCity(await getCollection("news"), name);
---

<Layout title={name}>
  <Navbar />
  <header class="pt-32 pb-6 relative">
    <div
      class="h-[50vh] w-full absolute top-0 left-0 -z-10 before:content-[''] before:absolute before:top-0 before:left-0 before:bottom-0 before:right-0 before:bg-black/60"
    >
      <Image src={singapore} alt="" class="object-cover w-full h-full" />
    </div>
    <div class="max-w-6xl px-4 mx-auto">
      <h1 class="font-bold text-5xl text-white">{name}</h1>
    </div>
  </header>
  <main>
    <ContentContainer>
      <div class="max-w-6xl px-4 mx-auto">
        <SectionHeader title={`Latest research on ${name}`} />
        <SectionHeader title={`Upcoming events on ${name}`} />
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mt-6 gap-x-4 gap-y-7"
        >
          {allCityEvents.map((event) => <EventCard {...event.data} />)}
        </div>
        <a href={`/events?city=${name}`}>
          <Button label={`View ${name} events`} class="mt-8 mb-16" />
        </a>
        <SectionHeader title={`Latest news on ${name}`} />
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mt-6 gap-x-4 gap-y-7"
        >
          {allCityNews.map((news) => <NewsCard {...news.data} />)}
        </div>
        <a href={`/news?city=${name}`}>
          <Button label={`View ${name} news`} class="mt-8 mb-16" />
        </a>
        <SectionHeader title={`Social media on ${name}`} />
      </div>
    </ContentContainer>
  </main>
  <Footer />
</Layout>
